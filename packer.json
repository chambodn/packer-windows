{
    "variables": {
        "project_id": "sandbox-249706",
        "account_file": "{{env `GKE_ACCOUNT`}}",
        "packer_user": "packer",
        "zone": "europe-west1-b",
        "pstools_url": "https://download.sysinternals.com/files/PSTools.zip"
    },
    "builders": [
        {
            "type": "googlecompute",
            "account_file": "{{user `account_file`}}",
            "project_id": "{{user `project_id`}}",
            "image_name": "packer-test",
            "source_image_family": "windows-2016",
            "disk_size": "50",
            "disk_type": "pd-ssd",
            "machine_type": "n1-standard-4",
            "image_description": "created-with-packer",
            "use_internal_ip": false,
            "communicator": "winrm",
            "winrm_username": "{{user `packer_user`}}",
            "winrm_insecure": true,
            "winrm_use_ssl": true,
            "metadata": {
                "sysprep-specialize-script-cmd": "winrm quickconfig -quiet & net user /add {{user `packer_user`}} & net localgroup administrators {{user `packer_user`}} /add & winrm set winrm/config/service/auth @{Basic=\"true\"}"
            },
            "zone": "{{ user `zone` }}"
        }
    ],  
    "provisioners": [
     {
      "type": "powershell",
      "inline": [
        "Write-Output \"Set TimeZone to Romance\"",
        "Set-TimeZone -Id \"Romance Standard Time\" -PassThru",

        "Write-Output \"Change unicode language\"",
        "Set-WinSystemLocale -SystemLocale en-GB",

        "Write-Output \"Ensure the required NuGet package provider version is installed\"",
        "Find-PackageProvider -Name Nuget -ForceBootstrap -IncludeDependencies -Force",
        
        "Write-Output \"Install PowerShellGet module\"",
        "Install-Module PowerShellGet -Force -AllowClobber",

        "Write-Output \"Install LoopbackAdapter module:\"",
        "Install-Module LoopbackAdapter -Force -AllowClobber",

        "Write-Output \"Download and install pstools\"",
        "Invoke-WebRequest -Uri {{user `pstools_url`}} -OutFile $env:TEMP\\pstools.zip'",
        "Microsoft.PowerShell.Archive\\Expand-Archive -Path $Env:TEMP\\pstools.zip -DestinationPath $env:TEMP\\pstools",
        "Move-Item -Path $env:TEMP\\pstools\\psexec.exe C:\\WINDOWS\\system32\\psexec.exe",
        "Remove-Item -Path $env:TEMP\\pstools -Recurse"
      ]
    },
    {
      "type":  "powershell",
      "scripts": [
        "scripts/02_win-updates.ps1",
        "scripts/03_update-registry.ps1"
        ],
      "elevated_user": "SYSTEM",
      "elevated_password": ""
    }
  ]
}
